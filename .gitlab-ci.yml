image: docker:latest
services:
  - docker:dind

stages:
  # - build
  - docker-build
  - deploy

variables:
  DOCKER_IMAGE_PATH: "$CI_REGISTRY_IMAGE"

.template:docker:build: &docker-build
  before_script:
    # Log in to GitLab Container Registry
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
  script:
    - echo version:$CI_TAG
    - docker build
      --build-arg BUILDKIT_INLINE_CACHE=1
      --build-arg BUILDKIT_INLINE_CACHE=1
      --build-arg REACT_APP_STRAPI_URL=$REACT_APP_STRAPI_URL --build-arg REACT_APP_SURA_URL=$REACT_APP_SURA_URL --build-arg REACT_APP_SUBSCRIPTION_ID=$REACT_APP_SUBSCRIPTION_ID
      --build-arg REACT_APP_RESOURCE_GROUP_NAME=$REACT_APP_RESOURCE_GROUP_NAME --build-arg REACT_APP_SERVICE_NAME=$REACT_APP_SERVICE_NAME --build-arg REACT_APP_API_VERSION=$REACT_APP_API_VERSION
      --build-arg REACT_APP_REMEMBER_KEY=$REACT_APP_REMEMBER_KEY --build-arg REACT_APP_PRIMARY_KEY=$REACT_APP_PRIMARY_KEY --build-arg REACT_APP_APIM_UID=$REACT_APP_APIM_UID
      --build-arg REACT_APP_TOKEN_VALID_DAYS=$REACT_APP_TOKEN_VALID_DAYS --build-arg REACT_APP_LIST_API_TOP=$REACT_APP_LIST_API_TOP --build-arg REACT_APP_LIST_PRODUCT_APIS_TOP=$REACT_APP_LIST_PRODUCT_APIS_TOP
      --build-arg REACT_APP_LIST_PRODUCT_TOP=$REACT_APP_LIST_PRODUCT_TOP --build-arg REACT_APP_LIST_SUBSCRIPTIONS=$REACT_APP_LIST_SUBSCRIPTIONS
      --cache-from "${DOCKER_IMAGE_PATH}:$TAG"
      -t "${DOCKER_IMAGE_PATH}:$CI_TAG" -t "${DOCKER_IMAGE_PATH}:$TAG" .
    - docker push $DOCKER_IMAGE_PATH:$TAG
    - docker push $DOCKER_IMAGE_PATH:$CI_TAG

.template:deploy: &ssh-deploy
  script:
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - echo "$PRIVATE_RSA_KEY" | tr -d '\r' > ssh-auth
    - chmod 600 ssh-auth
    - sed -i "s|IMAGE_VERSION|$CI_COMMIT_SHA|g;" docker-compose.yaml
    - scp -i ssh-auth docker-compose.yaml $SSH_LOGIN:$REMOTE_PATH/docker-compose.yaml
    - ssh -i ssh-auth $SSH_LOGIN "cd $REMOTE_PATH && docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com && docker-compose down && docker-compose up -d "

docker:build:
  stage: docker-build
  variables:
    TAG: $CI_COMMIT_REF_NAME
    CI_TAG: $CI_COMMIT_SHA
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+(\.[0-9]+)+(\.[0-9]+)$/
      variables:
        TAG: latest
        CI_TAG: $CI_COMMIT_TAG
    - if: $CI_COMMIT_REF_NAME == "pre"
    # - if: $CI_COMMIT_REF_NAME == "develop"

  <<: *docker-build

docker:deploy:
  stage: deploy
  variables:
    SSH_LOGIN: ubuntu@$PRE_UBUNTU
    SSH_KEY: $PRIVATE_RSA_KEY
  rules:
    # - if: $CI_COMMIT_REF_NAME == "develop"
    #   variables:
    #     REMOTE_PATH: /var/www/aplicacion/devportal-sura-front/dev
    - if: $CI_COMMIT_REF_NAME == "pre"
      variables:
        REMOTE_PATH: /var/www/aplicacion/devportal-sura-front/pre
  <<: *ssh-deploy
  environment:
    name: $CI_COMMIT_REF_NAME
# .template:build: &build
#   stage: build
#   image: node:alpine
#   script:
#     # - export NODE_OPTIONS=--openssl-legacy-provider
#     - export NODE_ENV=production
#     - npm install
#     - npm run build
#   artifacts:
#     paths:
#       - build
#       - .next

# build:pre:
#   <<: *build
#   environment:
#     name: pre
#   only:
#     refs:
#       - pre
