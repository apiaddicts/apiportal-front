image: docker:latest
services:
  - docker:dind

stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE_PATH: "$CI_REGISTRY_IMAGE"
.template:docker:build: &docker-build
  before_script:
    # Log in to GitLab Container Registry
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
  script:
    - echo version:$CI_TAG
    - docker build 
        --build-arg BUILDKIT_INLINE_CACHE=1 
        --build-arg REACT_APP_STRAPI_URL=$REACT_APP_STRAPI_URL
        --build-arg REACT_APP_AZURE_APIM_URL=$REACT_APP_AZURE_APIM_URL
        --build-arg REACT_APP_AZURE_SUBSCRIPTION_ID=$REACT_APP_AZURE_SUBSCRIPTION_ID
        --build-arg REACT_APP_AZURE_RESOURCE_GROUP_NAME=$REACT_APP_AZURE_RESOURCE_GROUP_NAME
        --build-arg REACT_APP_AZURE_SERVICE_NAME=$REACT_APP_AZURE_SERVICE_NAME
        --build-arg REACT_APP_API_VERSION=$REACT_APP_API_VERSION
        --build-arg REACT_APP_REMEMBER_KEY=$REACT_APP_REMEMBER_KEY
        --build-arg REACT_APP_AZURE_APIM_ADMIN_API_PRIMARY_KEY=$REACT_APP_AZURE_APIM_ADMIN_API_PRIMARY_KEY
        --build-arg REACT_APP_AZURE_APIM_ADMIN_API_UID=$REACT_APP_AZURE_APIM_ADMIN_API_UID
        --build-arg REACT_APP_AZURE_APIM_ADMIN_API_TOKEN_VALID_DAYS=$REACT_APP_AZURE_APIM_ADMIN_API_TOKEN_VALID_DAYS
        --build-arg REACT_APP_LIST_API_TOP=$REACT_APP_LIST_API_TOP
        --build-arg REACT_APP_LIST_PRODUCT_APIS_TOP=$REACT_APP_LIST_PRODUCT_APIS_TOP
        --build-arg REACT_APP_LIST_PRODUCT_TOP=$REACT_APP_LIST_PRODUCT_TOP
        --build-arg REACT_APP_LIST_SUBSCRIPTIONS=$REACT_APP_LIST_SUBSCRIPTIONS
        --build-arg WDS_SOCKET_PORT=$WDS_SOCKET_PORT
        --build-arg REACT_APP_HOME_PAGE_SLUG=$REACT_APP_HOME_PAGE_SLUG
        --build-arg REACT_APP_BLOG_PAGE_SLUG=$REACT_APP_BLOG_PAGE_SLUG
        --build-arg REACT_APP_FAQ_PAGE_SLUG=$REACT_APP_FAQ_PAGE_SLUG
        --build-arg REACT_APP_APIS_PAGE_SLUG=$REACT_APP_APIS_PAGE_SLUG
        --build-arg REACT_APP_TERMS_PAGE_SLUG=$REACT_APP_TERMS_PAGE_SLUG
        --build-arg REACT_APP_POLICY_PAGE_SLUG=$REACT_APP_POLICY_PAGE_SLUG
        --cache-from "${DOCKER_IMAGE_PATH}:$TAG"
        -t "${DOCKER_IMAGE_PATH}:$CI_TAG" -t "${DOCKER_IMAGE_PATH}:$TAG" .

    - docker push $DOCKER_IMAGE_PATH:$TAG
    - docker push $DOCKER_IMAGE_PATH:$CI_TAG

.template:deploy: &ssh-deploy
  script:
    - apk add gettext
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - echo "$PRIVATE_RSA_KEY" | tr -d '\r' > ssh-auth
    - chmod 600 ssh-auth
    - envsubst < docker-compose.yaml > docker-compose.yaml.tmp
    - scp -i ssh-auth docker-compose.yaml.tmp $SSH_LOGIN:$REMOTE_PATH/docker-compose.yaml
    - ssh -i ssh-auth $SSH_LOGIN "cd $REMOTE_PATH && docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com && docker-compose down && docker-compose up -d "

docker:build:
  stage: build
  variables:
    TAG: $CI_COMMIT_REF_NAME
    CI_TAG: $CI_COMMIT_SHA
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+(\.[0-9]+)+(\.[0-9]+)$/
      variables:
        TAG: latest
        CI_TAG: $CI_COMMIT_TAG
    - if: $CI_COMMIT_REF_NAME == "main"
    # - if: $CI_COMMIT_REF_NAME == "develop"

  <<: *docker-build

docker:deploy:
  stage: deploy
  variables:
    SSH_LOGIN: ubuntu@$PRE_UBUNTU
    SSH_KEY: $PRIVATE_RSA_KEY
    REMOTE_PATH: /var/www/aplicacion/devportal-clo-front
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
  <<: *ssh-deploy
  environment:
    name: $CI_COMMIT_REF_NAME

