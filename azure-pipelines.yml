trigger:
  branches:
    include:
      - develop
      - main
      - pre

pool:
  name: Azure Pipelines
  vmImage: ubuntu-20.04

variables:
  azName: devportal-front
  gitlabRepository: cloudappi/sura/dev-portal-sura-frontend
  azPort: 3000
  azImage: $(dockerRegistry)/$(gitlabRepository):$(Build.SourceVersion)
  dockerRegistry: registry.gitlab.com
  dockerRegistryConnection: Cloudappi-GitlabRegistry
  ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
    openshiftServiceConnection: "ARO-Dev"
    environment: dev

stages:
  - stage: Build
    jobs:
      - job: Build
        variables:
          - group: frontend-variables-${{variables.environment}}
        steps:
          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: $(dockerRegistryConnection)
          - task: Docker@2
            displayName: Build
            inputs:
              command: build
              repository: $(gitlabRepository)
              Dockerfile: Dockerfile
              buildContext: .
              args: --build-arg REACT_APP_RESOURCE_GROUP_NAME --build-arg REACT_APP_SERVICE_NAME --build-arg REACT_APP_STRAPI_URL --build-arg REACT_APP_SUBSCRIPTION_ID --build-arg REACT_APP_SURA_URL
              tags: |
                $(Build.SourceBranchName)
                $(Build.SourceVersion)
          - task: Docker@2
            displayName: Push
            inputs:
              command: push
              repository: $(gitlabRepository)
              tags: |
                $(Build.SourceBranchName)
                $(Build.SourceVersion)
  - stage: Deploy
    jobs:
      - deployment: Deploy
        variables:
          - group: frontend-variables-${{variables.environment}}
            #ENVIRONMENT: 'Development'
        displayName: "Deploy to Dev"
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  submodules: true
                # Install oc so that it can be used within a 'script' or bash 'task'
                - task: oc-setup@2
                  displayName: Setup oc
                  inputs:
                    openshiftService: $(openshiftServiceConnection)
                # A script task making use of 'oc'
                - script: |
                    envsubst < openshift/manifest.yaml | oc apply -n api-cloud-dev -f -
                  displayName: Apply deployment
                # Single shot 'oc' command
                - task: oc-cmd@2
                  displayName: Wait for deployment
                  inputs:
                    openshiftService: $(openshiftServiceConnection)
                    cmd: "rollout status -w deployment/$(azName)"
