FROM node:12-alpine AS build-stage
# ENV NODE_OPTIONS=--openssl-legacy-provider
ENV NODE_ENV production
ENV DISABLE_ESLINT_PLUGIN true
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app
RUN apk update \
    && apk --no-cache --update add build-base 

RUN apk add --update --no-cache python3 && ln -sf python3 /usr/bin/python
RUN python3 -m ensurepip
RUN pip3 install --no-cache --upgrade pip setuptools

COPY package*.json /usr/src/app/
# USER node
ARG REACT_APP_STRAPI_URL
ARG REACT_APP_SURA_URL
ARG REACT_APP_SUBSCRIPTION_ID
ARG REACT_APP_RESOURCE_GROUP_NAME
ARG REACT_APP_SERVICE_NAME
ARG REACT_APP_API_VERSION
ARG REACT_APP_REMEMBER_KEY
ARG REACT_APP_PRIMARY_KEY
ARG REACT_APP_APIM_UID
ARG REACT_APP_TOKEN_VALID_DAYS
ARG REACT_APP_LIST_API_TOP
ARG REACT_APP_LIST_PRODUCT_APIS_TOP
ARG REACT_APP_LIST_PRODUCT_TOP
ARG REACT_APP_LIST_SUBSCRIPTIONS
ARG WDS_SOCKET_PORT
ARG REACT_APP_HOME_PAGE_SLUG
ARG REACT_APP_BLOG_PAGE_SLUG
ARG REACT_APP_FAQ_PAGE_SLUG
ARG REACT_APP_APIS_PAGE_SLUG
# Configuration email
ARG REACT_APP_EMAIL_ENDPOINT
ARG REACT_APP_API_KEY_SEND_GRID
ARG REACT_APP_EMAIL_SUBSCRIPTION_KEY
ARG REACT_APP_EMAIL_FROM
ARG REACT_APP_EMAIL_CONVERSATION_TEMPLATE_ID
ARG REACT_APP_EMAIL_CONTACT_TEMPLATE_ID

ENV REACT_APP_STRAPI_URL=${REACT_APP_STRAPI_URL}
ENV REACT_APP_SURA_URL=${REACT_APP_SURA_URL}
ENV REACT_APP_SUBSCRIPTION_ID=${REACT_APP_SUBSCRIPTION_ID}
ENV REACT_APP_RESOURCE_GROUP_NAME=${REACT_APP_RESOURCE_GROUP_NAME}
ENV REACT_APP_SERVICE_NAME=${REACT_APP_SERVICE_NAME}
ENV REACT_APP_API_VERSION=${REACT_APP_API_VERSION}
ENV REACT_APP_REMEMBER_KEY=${REACT_APP_REMEMBER_KEY}
ENV REACT_APP_PRIMARY_KEY=${REACT_APP_PRIMARY_KEY}
ENV REACT_APP_APIM_UID=${REACT_APP_APIM_UID}
ENV REACT_APP_TOKEN_VALID_DAYS=${REACT_APP_TOKEN_VALID_DAYS}
ENV REACT_APP_LIST_API_TOP=${REACT_APP_LIST_API_TOP}
ENV REACT_APP_LIST_PRODUCT_APIS_TOP=${REACT_APP_LIST_PRODUCT_APIS_TOP}
ENV REACT_APP_LIST_PRODUCT_TOP=${REACT_APP_LIST_PRODUCT_TOP}
ENV REACT_APP_LIST_SUBSCRIPTIONS=${REACT_APP_LIST_SUBSCRIPTIONS}
ENV WDS_SOCKET_PORT=${WDS_SOCKET_PORT}
ENV REACT_APP_HOME_PAGE_SLUG=${REACT_APP_HOME_PAGE_SLUG}
ENV REACT_APP_BLOG_PAGE_SLUG=${REACT_APP_BLOG_PAGE_SLUG}
ENV REACT_APP_FAQ_PAGE_SLUG=${REACT_APP_FAQ_PAGE_SLUG}
ENV REACT_APP_APIS_PAGE_SLUG=${REACT_APP_APIS_PAGE_SLUG}
# Configuration email
ENV REACT_APP_EMAIL_ENDPOINT=${REACT_APP_EMAIL_ENDPOINT}
ENV REACT_APP_API_KEY_SEND_GRID=${REACT_APP_API_KEY_SEND_GRID}
ENV REACT_APP_EMAIL_SUBSCRIPTION_KEY=${REACT_APP_EMAIL_SUBSCRIPTION_KEY}
ENV REACT_APP_EMAIL_FROM=${REACT_APP_EMAIL_FROM}
ENV REACT_APP_EMAIL_CONVERSATION_TEMPLATE_ID=${REACT_APP_EMAIL_CONVERSATION_TEMPLATE_ID}
ENV REACT_APP_EMAIL_CONTACT_TEMPLATE_ID=${REACT_APP_EMAIL_CONTACT_TEMPLATE_ID}

RUN npm install

COPY . /usr/src/app/
RUN npm run build
#EXPOSE 3000
#CMD [ "npm", "run", "start" ]

FROM nginx:1.23
COPY --from=build-stage /usr/src/app/build/ /usr/share/nginx/html
COPY --from=build-stage /usr/src/app/nginx.conf /etc/nginx/conf.d/default.conf